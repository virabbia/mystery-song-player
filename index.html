<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitster Versi√≥n Viki v1.8</title>

  <!-- 1) Carga CORRECTA de html5‚Äëqrcode ANTES de tu c√≥digo -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <!-- 2) Fuentes y estilos -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      font-family: 'Open Sans', sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      height: 100vh; overflow: hidden;
    }
    header {
      font-family: 'Fredoka One', cursive;
      font-size: 3rem; color: #fff;
      text-shadow: 2px 2px #ff6363;
      margin-bottom: 10px; text-align: center;
    }
    header small {
      font-size: 1rem; opacity: .8; vertical-align: middle;
    }
    .content-wrapper {
      background: #fff; border-radius: 20px;
      padding: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      text-align: center; width: 80%; max-width: 600px;
    }
    .play-button {
      background: #ff6363; color: #fff; border: none;
      padding: 10px 20px; border-radius: 30px;
      font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 10px rgba(255,99,99,0.4);
      transition: transform .2s, box-shadow .2s;
      font-size: .9rem;
    }
    .play-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 15px rgba(255,99,99,0.6);
    }
    #qr-reader { margin:20px auto; width:300px; }
    .music-bars {
      display:flex; justify-content:center; align-items:flex-end;
      margin-top:20px;
    }
    .bar {
      width:10px; height:40px; margin:0 5px;
      background:#ff9a9e; animation:bounce 1s infinite alternate;
    }
    .bar:nth-child(2){animation-delay:.2s;}
    .bar:nth-child(3){animation-delay:.4s;}
    .bar:nth-child(4){animation-delay:.6s;}
    .bar:nth-child(5){animation-delay:.8s;}
    @keyframes bounce{0%{height:40px;}100%{height:100px;}}
    .dancing-viki {
      position:absolute; bottom:10px; right:10px;
      width:120px; animation:flip-dance 1.5s infinite;
    }
    @keyframes flip-dance{0%,100%{transform:scaleX(1);}50%{transform:scaleX(-1);}}
  </style>
</head>
<body>
  <header>Hitster Versi√≥n Viki <small>v1.8</small></header>
  <div class="content-wrapper">
    <button id="start-button" class="play-button">Iniciar escaneo</button>
    <div id="qr-reader" style="display:none;"></div>
    <div id="player-section" style="display:none;">
      <p>üé∂ Reproduciendo tu canci√≥n...</p>
      <div class="music-bars">
        <div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div>
        <div class="bar"></div>
      </div>
      <button id="scan-again" class="play-button" style="margin-top:15px;">
        Escanear otro QR
      </button>
    </div>
  </div>
  <img src="https://github.com/virabbia/mystery-song-player/raw/main/vikibailarina.png"
       alt="Dancing Viki" class="dancing-viki">

  <!-- 3) L√≥gica JavaScript embebida con mejoras -->
  <script>
    const VERSION   = 'v1.8';
    const CLIENT_ID = '0e507d976bac454da727e5da965c22fb';
    console.log(`[${VERSION}] P√°gina cargada: ${location.href}`);

    const startBtn     = document.getElementById('start-button');
    const qrReader     = document.getElementById('qr-reader');
    const playerSect   = document.getElementById('player-section');
    const scanAgainBtn = document.getElementById('scan-again');
    let html5QrCode;

    // Al hacer click, iniciamos escaneo
    startBtn.addEventListener('click', () => {
      console.log(`[${VERSION}] click en Iniciar escaneo`);
      startBtn.disabled = true;
      if (!window.Html5Qrcode) {
        const msg = '‚ö†Ô∏è html5‚Äëqrcode NO est√° definido. Revisa el <script> en el <head>.';
        console.error(`[${VERSION}] ${msg}`);
        return alert(msg);
      }
      startBtn.style.display = 'none';
      qrReader.style.display = 'block';
      initScanner();
    });

    // Configurar y arrancar lector
    function initScanner() {
      console.log(`[${VERSION}] initScanner()`);
      html5QrCode = new Html5Qrcode("qr-reader");
      Html5Qrcode.getCameras()
        .then(cams => {
          if (!cams.length) throw new Error('No hay c√°maras disponibles');
          console.log(`[${VERSION}] C√°maras detectadas:`, cams);
          return html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            err => console.warn(`[${VERSION}] No pudo leer QR:`, err)
          );
        })
        .catch(e => {
          console.error(`[${VERSION}] ERROR initScanner/cameras:`, e);
          alert(`Error c√°mara:\n${e.message}`);
        });
    }

    // Cuando detecta QR
    function onScanSuccess(decodedText) {
      console.log(`[${VERSION}] QR detectado:`, decodedText);
      // Acepta spotify:track:ID o https://open.spotify.com/track/ID
      const match = decodedText.match(/(?:spotify:track:|https:\/\/open\.spotify\.com\/track\/)([A-Za-z0-9]+)/);
      if (!match) {
        alert('üîç El QR no contiene una pista Spotify v√°lida.');
        return console.warn(`[${VERSION}] Formato no v√°lido:`, decodedText);
      }
      const trackUri = `spotify:track:${match[1]}`;
      html5QrCode.stop()
        .then(() => {
          console.log(`[${VERSION}] Esc√°ner detenido`);
          // 1) Primero reproducimos
          playTrack(trackUri)
            .then(() => {
              console.log(`[${VERSION}] Reproducci√≥n iniciada`);
              // 2) Despu√©s mostramos ‚ÄúEscanear otro QR‚Äù
              qrReader.style.display   = 'none';
              playerSect.style.display = 'block';
            });
        })
        .catch(e => {
          console.error(`[${VERSION}] ERROR detener esc√°ner:`, e);
          alert(`Error detener esc√°ner:\n${e.message}`);
        });
    }

    // Re-scan al clicar
    scanAgainBtn.addEventListener('click', () => {
      console.log(`[${VERSION}] click en Escanear otro QR`);
      playerSect.style.display = 'none';
      qrReader.style.display   = 'block';
      initScanner();
    });

    // Reproducir en Spotify
    async function playTrack(trackUri) {
      console.log(`[${VERSION}] playTrack() ‚Üí ${trackUri}`);
      try {
        let token = localStorage.getItem('spotifyAccessToken');
        if (!token || !location.hash.includes('#authenticated')) {
          console.log(`[${VERSION}] No autenticado, redirigiendo a Auth`);
          localStorage.setItem('trackId', trackUri.split(':').pop());
          const authUrl =
            `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
            `&redirect_uri=${encodeURIComponent(location.origin + '/callback.html')}` +
            `&scope=user-modify-playback-state&response_type=token`;
          location.href = authUrl;
          return;
        }
        const res = await fetch('https://api.spotify.com/v1/me/player/play', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ uris: [ trackUri ] })
        });
        if (!res.ok) {
          const msg = `Spotify API error: HTTP ${res.status}`;
          console.error(`[${VERSION}] ${msg}`);
          throw new Error(msg);
        }
        console.log(`[${VERSION}] Song sent (HTTP ${res.status})`);
      } catch (e) {
        console.error(`[${VERSION}] ERROR playTrack:`, e);
        alert(`Error reproduciendo:\n${e.message}`);
      }
    }
  </script>
</body>
</html>
