<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hitster Versi√≥n Viki v1.4</title>

  <!-- 1) Intentamos cargar html5-qrcode desde varios CDNs -->
  <script>
    const VERSION = 'v1.4';
    console.log(`[${VERSION}] ‚ñ∂Ô∏è Iniciando carga de html5-qrcode`);

    window._qrLoaded = false;
    window._qrFailed = false;

    const cdnList = [
      'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js',
      'https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js'
    ];
    let cdnIndex = 0;

    function loadNextCdn() {
      if (cdnIndex >= cdnList.length) {
        console.error(`[${VERSION}] ‚ùå Todos los CDNs de html5-qrcode fallaron`);
        window._qrFailed = true;
        return;
      }
      const src = cdnList[cdnIndex++];
      console.log(`[${VERSION}] üåê Probando carga desde: ${src}`);
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => {
        console.log(`[${VERSION}] ‚úÖ html5-qrcode cargado desde ${src}`);
        window._qrLoaded = true;
      };
      s.onerror = () => {
        console.warn(`[${VERSION}] ‚ö†Ô∏è Fall√≥ carga desde ${src}`);
        loadNextCdn();
      };
      document.head.appendChild(s);
    }
    loadNextCdn();
  </script>

  <!-- 2) Estilos y fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      font-family: 'Open Sans', sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      height: 100vh; overflow: hidden;
    }
    header {
      font-family: 'Fredoka One', cursive;
      font-size: 3rem; color: #fff;
      text-shadow: 2px 2px #ff6363;
      margin-bottom: 10px; text-align: center;
    }
    header small {
      font-size: 1rem; opacity: .8; vertical-align: middle;
    }
    .content-wrapper {
      background: #fff; border-radius: 20px;
      padding: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      text-align: center; width: 80%; max-width: 600px;
    }
    .play-button {
      background: #ff6363; color: #fff; border: none;
      padding: 10px 20px; border-radius: 30px;
      font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 10px rgba(255,99,99,0.4);
      transition: transform .2s, box-shadow .2s;
      font-size: .9rem;
    }
    .play-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 15px rgba(255,99,99,0.6);
    }
    #qr-reader { margin:20px auto; width:300px; }
    .music-bars {
      display:flex; justify-content:center; align-items:flex-end;
      margin-top:20px;
    }
    .bar {
      width:10px; height:40px; margin:0 5px;
      background:#ff9a9e; animation:bounce 1s infinite alternate;
    }
    .bar:nth-child(2){animation-delay:.2s;}
    .bar:nth-child(3){animation-delay:.4s;}
    .bar:nth-child(4){animation-delay:.6s;}
    .bar:nth-child(5){animation-delay:.8s;}
    @keyframes bounce{0%{height:40px;}100%{height:100px;}}
    .dancing-viki {
      position:absolute; bottom:10px; right:10px;
      width:120px; animation:flip-dance 1.5s infinite;
    }
    @keyframes flip-dance {
      0%,100%{transform:scaleX(1);}50%{transform:scaleX(-1);}
    }
  </style>
</head>
<body>
  <header>Hitster Versi√≥n Viki <small>v1.4</small></header>
  <div class="content-wrapper">
    <button id="start-button" class="play-button">Iniciar escaneo</button>
    <div id="qr-reader" style="display:none;"></div>
    <div id="player-section" style="display:none;">
      <p>üé∂ Reproduciendo tu canci√≥n...</p>
      <div class="music-bars">
        <div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div>
        <div class="bar"></div>
      </div>
      <button id="scan-again" class="play-button" style="margin-top:15px;">
        Escanear otro QR
      </button>
    </div>
  </div>
  <img src="https://github.com/virabbia/mystery-song-player/raw/main/vikibailarina.png"
       alt="Dancing Viki" class="dancing-viki">

  <!-- 3) L√≥gica JS -->
  <script>
    console.log(`[${VERSION}] P√°gina cargada: ${location.href}`);

    const startBtn     = document.getElementById('start-button');
    const qrReader     = document.getElementById('qr-reader');
    const playerSect   = document.getElementById('player-section');
    const scanAgainBtn = document.getElementById('scan-again');
    let html5QrCode;

    startBtn.addEventListener('click', () => {
      console.log(`[${VERSION}] click en Iniciar escaneo`);
      startBtn.disabled = true;

      if (!window._qrLoaded) {
        const msg = window._qrFailed
          ? 'No se pudo cargar html5-qrcode desde ning√∫n CDN.'
          : 'html5-qrcode a√∫n no ha terminado de cargarse. Espera unos segundos y vuelve a intentarlo.';
        console.error(`[${VERSION}] ${msg}`);
        return alert(msg);
      }

      startBtn.style.display = 'none';
      qrReader.style.display = 'block';
      initScanner();
    });

    function initScanner() {
      console.log(`[${VERSION}] initScanner()`);
      try {
        html5QrCode = new Html5Qrcode("qr-reader");
        Html5Qrcode.getCameras()
          .then(cams => {
            if (!cams.length) throw new Error('No hay c√°maras disponibles');
            console.log(`[${VERSION}] C√°maras detectadas:`, cams);
            return html5QrCode.start(
              { facingMode: "environment" },
              { fps: 10, qrbox: 250 },
              onScanSuccess,
              err => console.warn(`[${VERSION}] Error menor escaneo:`, err)
            );
          })
          .catch(e => {
            console.error(`[${VERSION}] ERROR initScanner/cameras:`, e);
            alert(`Error accediendo a la c√°mara:\n${e.message}`);
          });
      } catch (e) {
        console.error(`[${VERSION}] ERROR initScanner:`, e);
        alert(`Error al inicializar el esc√°ner:\n${e.message}`);
      }
    }

    function onScanSuccess(decodedText) {
      console.log(`[${VERSION}] QR detectado:`, decodedText);
      const m = decodedText.match(/spotify:track:[A-Za-z0-9]+/);
      if (!m) {
        console.warn(`[${VERSION}] QR no v√°lido para Spotify`);
        return alert('El c√≥digo QR no contiene una pista de Spotify v√°lida.');
      }
      const trackUri = m[0];
      html5QrCode.stop()
        .then(() => {
          console.log(`[${VERSION}] Esc√°ner detenido`);
          qrReader.style.display   = 'none';
          playerSect.style.display = 'block';
          playTrack(trackUri);
        })
        .catch(e => {
          console.error(`[${VERSION}] ERROR deteniendo esc√°ner:`, e);
          alert(`Error al detener el esc√°ner:\n${e.message}`);
        });
    }

    scanAgainBtn.addEventListener('click', () => {
      console.log(`[${VERSION}] click en Escanear otro QR`);
      playerSect.style.display = 'none';
      qrReader.style.display   = 'block';
      initScanner();
    });

    async function playTrack(trackUri) {
      console.log(`[${VERSION}] playTrack() ‚Üí ${trackUri}`);
      try {
        let token = localStorage.getItem('spotifyAccessToken');
        if (!token || !location.hash.includes('#authenticated')) {
          console.log(`[${VERSION}] No autenticado, redirigiendo a Spotify Auth`);
          localStorage.setItem('trackId', trackUri.split(':').pop());
          const authUrl =
            `https://accounts.spotify.com/authorize?client_id=0e507d976bac454da727e5da965c22fb` +
            `&redirect_uri=${encodeURIComponent(location.origin + '/callback.html')}` +
            `&scope=user-modify-playback-state&response_type=token`;
          return window.location.href = authUrl;
        }
        const res = await fetch('https://api.spotify.com/v1/me/player/play', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ uris: [ trackUri ] })
        });
        if (!res.ok) throw new Error(`Status ${res.status} ${res.statusText}`);
        console.log(`[${VERSION}] Canci√≥n enviada a Spotify (HTTP ${res.status})`);
      } catch (e) {
        console.error(`[${VERSION}] ERROR playTrack:`, e);
        alert(`Error reproduciendo en Spotify:\n${e.message}`);
      }
    }
  </script>
</body>
</html>
