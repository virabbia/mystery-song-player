  <!-- â€¦ justo antes de cerrar </body> â€¦ -->
  <script>
    const VERSION   = 'v2.4-debug';
    const CLIENT_ID = '0e507d976bac454da727e5da965c22fb';
    console.log(`[${VERSION}] PÃ¡gina cargada:`, location.href);

    // Elemento para mostrar estado en pantalla
    const wrapper  = document.querySelector('.content-wrapper');
    const statusEl = document.createElement('p');
    statusEl.id      = 'status';
    statusEl.style   = 'font-size:.9rem;color:#333;margin:10px 0;';
    statusEl.textContent = 'ğŸ’¡ Listo para escanear';
    wrapper.prepend(statusEl);

    function setStatus(msg) {
      console.log(`[${VERSION}] ${msg}`);
      statusEl.textContent = msg;
    }

    // Referencias al DOM
    const startBtn     = document.getElementById('start-button');
    const scannerDiv   = document.getElementById('scanner-container');
    const playDiv      = document.getElementById('play-container');
    const againDiv     = document.getElementById('again-container');
    const playBtn      = document.getElementById('play-button');
    const scanAgainBtn = document.getElementById('scan-again');
    let html5QrCode, lastTrackUri;

    // URI exacta de callback
    const redirectUri = `${location.origin}${location.pathname}callback.html`;

    // 0) Modo post-auth al cargar
    window.addEventListener('load', () => {
      setStatus('Verificando callback de autenticaciÃ³nâ€¦');
      const params     = new URLSearchParams(location.search);
      const trackParam = params.get('track');
      if (trackParam && location.hash.includes('#authenticated')) {
        lastTrackUri = trackParam;
        setStatus(`âœ” Track detectado: ${lastTrackUri}`);
        startBtn.style.display   = 'none';
        scannerDiv.style.display = 'none';
        playDiv.style.display    = 'block';
      } else {
        setStatus('ğŸ’¡ Listo para iniciar escaneo');
      }
    });

    // 1) Iniciar escaneo
    startBtn.addEventListener('click', () => {
      setStatus('ğŸ” Iniciando escaneo de QRâ€¦');
      startBtn.style.display   = 'none';
      playDiv.style.display    = 'none';
      againDiv.style.display   = 'none';
      scannerDiv.style.display = 'block';
      initScanner();
    });

    // 2) Configurar lector
    function initScanner() {
      setStatus('ğŸ“· Solicitando acceso a cÃ¡maraâ€¦');
      html5QrCode = new Html5Qrcode('qr-reader');
      Html5Qrcode.getCameras()
        .then(cams => {
          setStatus(`ğŸ“· ${cams.length} cÃ¡maras disponibles, arrancando lector`);
          console.log(`[${VERSION}] CÃ¡maras:`, cams);
          return html5QrCode.start(
            { facingMode: 'environment' },
            { fps: 10, useBarCodeDetectorIfSupported: true },
            onScanSuccess
          );
        })
        .catch(err => {
          console.error(`[${VERSION}] ERROR escÃ¡ner:`, err);
          setStatus(`âŒ Error cÃ¡mara: ${err.message}`);
          alert(`No pude acceder a la cÃ¡mara:\n${err.message}`);
        });
    }

    // 3) Al detectar QR
    function onScanSuccess(decoded) {
      setStatus(`âœ… QR detectado: ${decoded}`);
      console.log(`[${VERSION}] QR decodificado:`, decoded);
      html5QrCode.stop()
        .then(() => html5QrCode.clear())
        .then(() => {
          const m = decoded.match(/(?:spotify:track:|open\.spotify\.com\/track\/)([A-Za-z0-9]+)/);
          if (!m) {
            setStatus('âŒ QR invÃ¡lido para Spotify');
            alert('QR invÃ¡lido para Spotify');
            return;
          }
          lastTrackUri = `spotify:track:${m[1]}`;
          setStatus(`âœ” Track vÃ¡lido: ${lastTrackUri}`);
          playDiv.style.display = 'block';
        })
        .catch(err => {
          console.error(`[${VERSION}] fallo stop/clear:`, err);
          setStatus(`âŒ Error deteniendo escÃ¡ner: ${err.message}`);
        });
    }

    // 4) Reproducir
    playBtn.addEventListener('click', async () => {
      setStatus(`ğŸ§ Preparando reproducciÃ³n de ${lastTrackUri}`);
      console.log(`[${VERSION}] playTrack â†’`, lastTrackUri);
      const token = localStorage.getItem('spotifyAccessToken');
      if (!token || !location.hash.includes('#authenticated')) {
        setStatus('ğŸ”‘ Token ausente o no autenticado, redirigiendoâ€¦');
        localStorage.setItem('trackId', lastTrackUri.split(':').pop());
        return window.location.href =
          `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&scope=user-modify-playback-state&response_type=token`;
      }
      try {
        setStatus('âŒ› Obteniendo dispositivos Spotifyâ€¦');
        const devRes  = await fetch('https://api.spotify.com/v1/me/player/devices', {
          headers: { Authorization: 'Bearer ' + token }
        });
        setStatus(`ğŸ“¡ Dispositivos HTTP status: ${devRes.status}`);
        const devJson = await devRes.json();
        console.log(devJson);
        setStatus(`ğŸ“¡ Dispositivos encontrados: ${devJson.devices.length}`);
        if (!devJson.devices.length) {
          setStatus('âŒ No hay dispositivos activos');
          alert('Activa playback en Spotify Web o App antes de reproducir.');
          return;
        }
        const deviceId = devJson.devices[0].id;
        setStatus(`âœ” Usando device_id: ${deviceId}`);
        console.log(`[${VERSION}] usando device_id:`, deviceId);

        setStatus('â–¶ Enviando comando play a la API Spotifyâ€¦');
        const playRes = await fetch(
          `https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,
          {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + token },
            body: JSON.stringify({ uris: [ lastTrackUri ] })
          }
        );
        setStatus(`â–¶ Play HTTP status: ${playRes.status}`);
        if (!playRes.ok) {
          const errText = await playRes.text();
          throw new Error(`HTTP ${playRes.status}: ${errText}`);
        }
        setStatus('ğŸ‰ ReproducciÃ³n iniciada');
        playDiv.style.display  = 'none';
        againDiv.style.display = 'block';

      } catch (e) {
        console.error(`[${VERSION}] ERROR playTrack:`, e);
        setStatus(`âŒ Error playTrack: ${e.message}`);
        alert(`Error al reproducir:\n${e.message}`);
      }
    });

    // 5) Escanear otra canciÃ³n
    scanAgainBtn.addEventListener('click', () => {
      setStatus('ğŸ’¡ Listo para escanear otra canciÃ³n');
      againDiv.style.display = 'none';
      startBtn.style.display = 'block';
    });
  </script>
