<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vikster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      color: white;
      text-align: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      font-size: 3rem;
      margin-top: 40px;
      letter-spacing: 2px;
      text-shadow: 2px 2px #00000055;
    }

    #version-tag {
      position: fixed;
      top: 10px;
      right: 15px;
      font-size: 0.9rem;
      background: #00000044;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: bold;
    }

    #status {
      font-size: 1.2rem;
      margin: 20px 0;
    }

    button, #start-button {
      background-color: #ffffff22;
      border: 2px solid #fff;
      color: white;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
    }

    button:hover, #start-button:hover {
      background-color: #fff;
      color: #333;
    }

    #scanner-container, #play-container, #again-container {
      display: none;
      margin-top: 20px;
    }

    #qr-reader {
      width: 300px;
      max-width: 90vw;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 10px;
    }

    /* Viki dancing in bottom right corner with mirror flip */
    .viki-dancer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 100px;
      animation: dance 1.8s infinite ease-in-out;
      z-index: 1000;
      transform-origin: center;
    }

    @keyframes dance {
      0% { transform: scaleX(1); }
      50% { transform: scaleX(-1); }
      100% { transform: scaleX(1); }
    }
  </style>
</head>
<body>

  <div id="version-tag">v2.5</div>

  <h1>üéß Vikster</h1>
  <p id="status">üí° Listo para escanear</p>

  <div id="start-button">üéØ Escanear canci√≥n</div>

  <div id="scanner-container">
    <div id="qr-reader"></div>
  </div>

  <div id="play-container">
    <button id="play-button">‚ñ∂ Reproducir canci√≥n</button>
  </div>

  <div id="again-container">
    <button id="scan-again">üîÅ Escanear otra</button>
  </div>

  <!-- Dancing Viki image -->
  <img src="vikibailarina.png" alt="Viki bailando" class="viki-dancer">

  <script>
    const VERSION   = 'v2.5';
    const CLIENT_ID = '0e507d976bac454da727e5da965c22fb';
    console.log(`[${VERSION}] P√°gina cargada:`, location.href);

    const statusEl       = document.getElementById('status');
    const startBtn       = document.getElementById('start-button');
    const scannerDiv     = document.getElementById('scanner-container');
    const playDiv        = document.getElementById('play-container');
    const againDiv       = document.getElementById('again-container');
    const playBtn        = document.getElementById('play-button');
    const scanAgainBtn   = document.getElementById('scan-again');

    let html5QrCode, lastTrackUri;

    const redirectUri = `${location.origin}${location.pathname}callback.html`;

    function setStatus(msg) {
      console.log(`[${VERSION}] ${msg}`);
      statusEl.textContent = msg;
    }

    async function playTrack() {
      setStatus(`üéß Preparando reproducci√≥n de ${lastTrackUri}`);
      const token = localStorage.getItem('spotifyAccessToken');
      if (!token || !location.hash.includes('#authenticated')) {
        setStatus('üîë Token ausente o no autenticado, redirigiendo‚Ä¶');
        localStorage.setItem('trackId', lastTrackUri.split(':').pop());
        return window.location.href =
          `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
          `&redirect_uri=${encodeURIComponent(redirectUri)}` +
          `&scope=user-modify-playback-state%20user-read-playback-state` +
          `&response_type=token`;
      }

      try {
        setStatus('‚åõ Obteniendo dispositivos Spotify‚Ä¶');
        const devRes  = await fetch('https://api.spotify.com/v1/me/player/devices', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const devJson = await devRes.json();

        if (!devJson.devices || !Array.isArray(devJson.devices)) {
          throw new Error("Token inv√°lido o no autorizado (401)");
        }

        if (!devJson.devices.length) {
          setStatus('‚ùå No hay dispositivos activos');
          alert('Activa playback en Spotify Web o App antes de reproducir.');
          return;
        }

        const deviceId = devJson.devices[0].id;
        setStatus(`‚úî Usando device_id: ${deviceId}`);
        const playRes = await fetch(
          `https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,
          {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + token },
            body: JSON.stringify({ uris: [ lastTrackUri ] })
          }
        );
        if (!playRes.ok) {
          const errText = await playRes.text();
          throw new Error(`HTTP ${playRes.status}: ${errText}`);
        }
        setStatus('üéâ Reproducci√≥n iniciada');
        playDiv.style.display  = 'none';
        againDiv.style.display = 'block';
      } catch (e) {
        console.error(`[${VERSION}] ERROR playTrack:`, e);
        setStatus(`‚ùå Error al reproducir: ${e.message}`);
        alert(`Error al reproducir:\n${e.message}`);
      }
    }

    window.addEventListener('load', () => {
      setStatus('Verificando callback de autenticaci√≥n‚Ä¶');
      const params     = new URLSearchParams(location.search);
      const trackParam = params.get('track');
      if (trackParam && location.hash.includes('#authenticated')) {
        lastTrackUri = trackParam;
        setStatus(`‚úî Track detectado: ${lastTrackUri}`);
        startBtn.style.display   = 'none';
        scannerDiv.style.display = 'none';
        playDiv.style.display    = 'none'; // ocultamos bot√≥n play
        playTrack(); // reproducimos autom√°ticamente
      } else {
        setStatus('üí° Listo para iniciar escaneo');
      }
    });

    startBtn.addEventListener('click', () => {
      setStatus('üîç Iniciando escaneo de QR‚Ä¶');
      startBtn.style.display   = 'none';
      playDiv.style.display    = 'none';
      againDiv.style.display   = 'none';
      scannerDiv.style.display = 'block';
      initScanner();
    });

    function initScanner() {
      setStatus('üì∑ Solicitando acceso a c√°mara‚Ä¶');
      html5QrCode = new Html5Qrcode('qr-reader');
      Html5Qrcode.getCameras()
        .then(cams => {
          setStatus(`üì∑ ${cams.length} c√°maras disponibles, arrancando lector`);
          return html5QrCode.start(
            { facingMode: 'environment' },
            { fps: 10, useBarCodeDetectorIfSupported: true },
            onScanSuccess
          );
        })
        .catch(err => {
          console.error(`[${VERSION}] ERROR esc√°ner:`, err);
          setStatus(`‚ùå Error c√°mara: ${err.message}`);
          alert(`No pude acceder a la c√°mara:\n${err.message}`);
        });
    }

    function onScanSuccess(decoded) {
      setStatus(`‚úÖ QR detectado: ${decoded}`);
      html5QrCode.stop()
        .then(() => html5QrCode.clear())
        .then(() => {
          const m = decoded.match(/(?:spotify:track:|open\.spotify\.com\/track\/)([A-Za-z0-9]+)/);
          if (!m) {
            setStatus('‚ùå QR inv√°lido para Spotify');
            alert('QR inv√°lido para Spotify');
            return;
          }
          lastTrackUri = `spotify:track:${m[1]}`;
          setStatus(`‚úî Track v√°lido: ${lastTrackUri}`);
          playDiv.style.display = 'none';
          scannerDiv.style.display = 'none';
          playTrack(); // üöÄ reproduce autom√°ticamente
        })
        .catch(err => {
          console.error(`[${VERSION}] fallo stop/clear:`, err);
          setStatus(`‚ùå Error deteniendo esc√°ner: ${err.message}`);
        });
    }

    scanAgainBtn.addEventListener('click', () => {
      setStatus('üí° Listo para escanear otra canci√≥n');
      againDiv.style.display = 'none';
      startBtn.style.display = 'block';
    });
  </script>
</body>
</html>
